# -*- python -*-
# ex: set syntax=python:
import os
from buildbot.plugins import *
from buildbot.status import html
from bmu.ext.buildbot import bmu_builder

TEST_REPO_URL = "git://github.com/{0}".format(os.environ('BMU_TEST_REPO'))

c = BuildmasterConfig = {}
c['builders'] = []
c['schedulers'] = []

c['slaves'] = [buildslave.BuildSlave("example-slave", "pass")]
c['protocols'] = {'pb': {'port': 9989}}
c['schedulers'].append(
    schedulers.AnyBranchScheduler(
        name="schedule-all",
        builderNames=['runtests'],
    )
)

pyflakes_factory = util.BuildFactory()
pyflakes_factory.addStep(steps.Git(repourl=TEST_REPO_URL, mode='incremental'))
pyflakes_factory.addStep(steps.ShellCommand(command=["pyflakes"]))
c['builders'].append(
    util.BuilderConfig(name="pyflakes",
      slavenames=["example-slave"],
      factory=pyflakes_factory
    )
)

pytest_factory = util.BuildFactory()
pytest_factory.addStep(steps.Git(repourl=TEST_REPO_URL, mode='incremental'))
pytest_factory.addStep(steps.ShellCommand(command=['py.test']))
c['builders'] = []
c['builders'].append(
    util.BuilderConfig(name="pytest",
      slavenames=["example-slave"],
      factory=pyflakes_factory
    )
)

c['builders'].append(bmu_builder(['example-slave'], ['pyflakes', 'pytest'])
c['status'] = [
    status.HttpStatusPush(serverUrl='http://localhost:9876'),
    html.WebStatus(http_port=8010, change_hook_dialects={'base': {}}),
]
c['title'] = 'Buildbot instance for BMU tests'
c['titleURL'] = 'https://github.com/bmcorser/bmu'
c['buildbotURL'] = "http://localhost:8010/"
c['db'] = {'db_url' : "sqlite:///state.sqlite"}
