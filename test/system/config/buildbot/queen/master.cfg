# -*- python -*-
# ex: set syntax=python:
import os
import buildbot
from buildbot.plugins import *
from buildbot.status import html
from buildbot.status.web import hooks
from bmu.ext.builder import bmu_builder, inject_bmu

inject_bmu(hooks)


TEST_REPO_URL = "git://github.com/{0}".format(os.environ['BMU_TEST_REPO'])

c = BuildmasterConfig = {}
c['builders'] = []
c['schedulers'] = []

c['slaves'] = [buildslave.BuildSlave('worker', 'pass')]
c['protocols'] = {'pb': {'port': 9989}}

def one_command_builder(name, command):
    f = util.BuildFactory()
    f.addStep(steps.Git(repourl=TEST_REPO_URL, mode='incremental'))
    f.addStep(steps.ShellCommand(command=command))
    builder = util.BuilderConfig(name=name, slavenames=['worker'], factory=f)
    c['builders'].append(builder)

BUILDERS = ('a/b', 'a/c', 'd/e/f', 'd/e/g', 'h')

for name in BUILDERS:
    one_command_builder(name, '$(exit 0)')

c['builders'].append(bmu_builder('bmu', ['worker'], BUILDERS))


c['status'] = [
    status.HttpStatusPush(serverUrl='http://localhost:9876'),
    html.WebStatus(http_port=8010, change_hook_dialects={'base': {}}),
]

c['schedulers'].append(
    schedulers.AnyBranchScheduler(
        name='schedule-all',
        builderNames=BUILDERS + ('bmu',),
    )
)

c['title'] = 'Buildbot instance for BMU tests'
c['titleURL'] = 'https://github.com/bmcorser/bmu'
c['buildbotURL'] = 'http://localhost:8010/'
c['db'] = {'db_url' : 'sqlite:///state.sqlite'}
